--- rpm-5.4.10/lib/rpmfc.c.desktop~	2013-02-01 04:30:52.345036560 +0100
+++ rpm-5.4.10/lib/rpmfc.c	2013-02-01 04:30:52.348036601 +0100
@@ -1007,6 +1007,17 @@ static int rpmfcSCRIPT(rpmfc fc)
 		xx = rpmfcHelper(fc, 'R', "kernel");
 	    }
 	mire = mireFree(mire);
+    }
+    if ((fc->fcolor->vals[fc->ix] & RPMFC_SCRIPT)) {
+	miRE mire = mireNew(RPMMIRE_REGEX, RPMTAG_FILEPATHS);
+	if (!mireRegcomp(mire, "^.*/usr/share/applications/.*\\.desktop$"))
+	    if (mireRegexec(mire, fc->fn[fc->ix], (size_t) 0) >= 0) {
+		fc->fcolor->vals[fc->ix] |= (RPMFC_MODULE|RPMFC_SCRIPT);
+		xx = rpmfcHelper(fc, 'P', "desktop");
+		/* XXX: currently of no use, but for the sake of consistency... */
+		xx = rpmfcHelper(fc, 'R', "desktop");
+	    }
+	mire = mireFree(mire);
 #endif
     }
 
@@ -1222,6 +1233,12 @@ assert(fc->fn != NULL);
 		    if (mireRegexec(mire, fc->fn[fc->ix], (size_t) 0) >= 0)
 			fc->fcolor->vals[fc->ix] |= (RPMFC_MODULE|RPMFC_SCRIPT);
 		mire = mireFree(mire);
+		mire = mireNew(RPMMIRE_REGEX, RPMTAG_FILEPATHS);
+		/* buttfuckin' retarded, but whatever.. it'll work at least! ;) */
+		if (!mireRegcomp(mire, "^.*/usr/share/applications/.*\\.desktop$"))
+		    if (mireRegexec(mire, fc->fn[fc->ix], (size_t) 0) >= 0)
+			fc->fcolor->vals[fc->ix] |= RPMFC_SCRIPT;
+		mire = mireFree(mire);
 #endif
 	    }
 	}
--- rpm-5.4.10/macros/macros.rpmbuild.in.desktop~	2013-02-01 04:30:52.342036517 +0100
+++ rpm-5.4.10/macros/macros.rpmbuild.in	2013-02-01 04:30:52.348036601 +0100
@@ -685,5 +685,8 @@ done \
 %__font_provides        %{_rpmhome}/fontconfig.prov
 #%__font_requires        %{_rpmhome}/fontconfig.req
 
+%__desktop_provides        %{_rpmhome}/desktop-file.prov
+#%__desktop_requires        %{_rpmhome}/desktop-file.prov
+
 # \endverbatim
 #*/
--- rpm-5.4.10/scripts/desktop-file.prov.desktop~	2013-02-01 04:30:52.348036601 +0100
+++ rpm-5.4.10/scripts/desktop-file.prov	2013-02-01 04:30:52.348036601 +0100
@@ -0,0 +1,23 @@
+#!/bin/sh
+#
+# Transform desktop mimetype info into RPM mimehandler(type) provides
+#
+# Author: Richard Hughes <richard@hughsie.com>
+# Based on other provides scripts from RPM
+
+OLD_IFS="$IFS"
+while read instfile ; do
+	case "$instfile" in
+	*.desktop)
+		if ! grep -q '^Type=Application$' "$instfile"; then continue; fi
+		if ! grep -q '^Exec=' "$instfile"; then continue; fi
+		mime=`grep '^MimeType=' "$instfile" | cut -d'=' -f2`
+		IFS=';'
+		for type in $mime ; do
+			echo 'mimehandler('$type')'
+		done
+		;;
+	esac
+done
+IFS=$OLD_IFS
+
--- rpm-5.4.10/scripts/Makefile.am.desktop~	2013-02-01 04:30:52.342036517 +0100
+++ rpm-5.4.10/scripts/Makefile.am	2013-02-01 04:31:30.151550239 +0100
@@ -10,7 +10,7 @@ EXTRA_DIST = api-sanity-autotest.pl api-
 	brp-strip brp-strip-comment-note brp-nobuildrootpath \
 	brp-strip-shared brp-strip-static-archive brp-sparc64-linux \
 	brp-implant-ident-static brp-java-repack-jars \
-	check-files cross-build dbconvert.sh \
+	check-files cross-build dbconvert.sh desktop-file.prov \
 	deb_Packages deb_Sources \
 	deb_control deb_md5sums deb_postinst deb_postrm deb_preinst deb_prerm \
 	executabledeps.sh \
@@ -53,7 +53,7 @@ pkgdata_SCRIPTS = \
 	brp-compress brp-python-bytecompile brp-java-gcjcompile \
 	brp-strip brp-strip-comment-note brp-nobuildrootpath \
 	brp-strip-shared brp-strip-static-archive brp-sparc64-linux \
-	check-files cross-build dbconvert.sh executabledeps.sh \
+	check-files cross-build dbconvert.sh desktop-file.prov executabledeps.sh \
 	find-debuginfo.sh find-lang.sh find-prov.pl find-req.pl \
 	find-provides.perl find-requires.perl \
 	fontconfig.prov gem_helper.rb getpo.sh haskelldeps.sh http.req \
