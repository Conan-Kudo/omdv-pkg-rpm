From d296443a0d69ca701b9b01dd05c3f541bfccc7e5 Mon Sep 17 00:00:00 2001
From: Gordon Messmer <gordon.messmer@gmail.com>
Date: Sun, 24 Nov 2019 15:58:29 -0800
Subject: [PATCH 3/5] scripts/pythondistdeps: Handle compatible-release
 operator.

(cherry picked from commit ed864b8842859cc387bafd63d283ced02c65490e)
---
 scripts/pythondistdeps.py | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/scripts/pythondistdeps.py b/scripts/pythondistdeps.py
index 94707d8f4..9e3f36138 100755
--- a/scripts/pythondistdeps.py
+++ b/scripts/pythondistdeps.py
@@ -102,7 +102,7 @@ for f in files:
             lower.endswith('.egg-info') or \
             lower.endswith('.dist-info'):
         # This import is very slow, so only do it if needed
-        from pkg_resources import Distribution, FileMetadata, PathMetadata, Requirement
+        from pkg_resources import Distribution, FileMetadata, PathMetadata, Requirement, parse_version
         dist_name = basename(f)
         if isdir(f):
             path_item = dirname(f)
@@ -246,6 +246,15 @@ for name in names:
         for spec in py_deps[name]:
             if spec[0] == '!=':
                 spec_list.append('{n} < {v} or {n} >= {v}.0'.format(n=name, v=spec[1]))
+            elif spec[0] == '~=':
+                # Parse the current version
+                next_ver = parse_version(spec[1]).base_version.split('.')
+                # Drop the micro version
+                next_ver = next_ver[0:-1]
+                # Increment the minor version
+                next_ver[-1] = str(int(next_ver[-1]) + 1)
+                next_ver = '.'.join(next_ver)
+                spec_list.append('{n} >= {v} with {n} < {vnext}'.format(n=name, v=spec[1], vnext=next_ver))
             else:
                 spec_list.append('{} {} {}'.format(name, spec[0], spec[1]))
         print('(%s)' % ' with '.join(spec_list))
-- 
2.21.0

